# JSON Configuration for Source Forms
The spec is available at https://docs.google.com/document/d/1XWkASe9bIUI-IyEjOvGhHJg9BmvyjZaMKZZdKEibFxE/


## Introduction
The screens for adding and modifying sources do not follow a consistent look and feel,
thereby surprising and confusing users. Going forward, we want consolidate the experience for these interfaces:
- Consistent interfaces for similar configuration options
- Single methodology for source-specific configurations
- Separate the configuration interface into well-defined tabs.

We will replace the current approach (independent coding of each source configuration that hopes to be consistent) with a data-driven method: the webApp will render configuration screens from data. Some basic information will come from the server and additional configuration details could be added in a well-defined format. As a result, we will separate the input form definition from the rendering of the configuration form interface to help our customers enjoy a predictable experience as they add more sources to their installation.

This document describes how information about form fields, generated by back end API, can be decorated to produce a source form in Dremio UI.

The layout details and styling of the forms is kept outside of this spec. It should be decided at the code level and applied uniformly to all forms.

The data describing forms comes from two parts:

- Source Configuration Definition API response which is used by FE to display and handle source forms in the browser.
- VLH - “visual layout hint” file (definition by Jacques). This supplements the server api response (no overlap). VLH is a part of the Front End code base for existing forms. In the future it may be provided by the server.

VLH is optional. If not provided for a given source type, FE code uses default tabbed layout. It shows all fields, included in API response, in a default section of General tab.

Server side source form config API needs to take into account the current user profile (which forms/tabs/sections make available to this user), the source form submittal API spec (to map elements property names to submittal api params), internal java code annotations, external source form specification data, and to generate API response in JSON format.

Source form config API should have two endpoints:
```
	/api/v3/source/type - returns the list of available types for the user
	/api/v3/source/type/<type code> - detailed configuration for the requested type
```

## Source Type List
### Functional Data from API

(see BE spec at https://docs.google.com/document/d/1Vy5TOAlmdCIUC69nmiAV3MeXZBgYgy4c0CANGfkfPXM):
API endpoint:
```
GET /api/v3/source/type
{“data”:
  [
    {
      “sourceType”: String - required
      “label”:  String - optional
      “Icon”: SVG text - optional
    }
  ]
}
```

### VLH data to decorate Functional List Data

- array of form types (each describes individual source type form)
    - sourceType (source form type code e.g. “S3” - required, used to match API entry)
    - tags (string array; currently “beta” means this form is in beta mode - optional)

## Source Type Detail for a Particular Type

### Functional Data from API

See BE spec at https://docs.google.com/document/d/1Vy5TOAlmdCIUC69nmiAV3MeXZBgYgy4c0CANGfkfPXM to find detail how the data is derived from java annotations.
API endpoint:
```
GET /api/v3/source/type/<type code>

{
  “sourceType”: String - required
  “label”:  String - optional
  “Icon”: SVG text - optional
  “elements”: [
    {
      “type”: String - required
      “propertyName”: String - required (assumed to be part of “config” object)
      “label”: String - optional
      “secret”: Boolean - optional
      “value”: Object - optional
    }
  ]
}
```

### VLH data to decorate Functional Source Type Detail

VLH for a particular source type has the following nested structure
    - <metadata>
    - form (describes individual form)
        - <tab>
          - <section>
            - <element or section>
              - <element or section>

##### Relationship:
- Forms hold tabs
- Tabs hold sections
- Sections hold elements and sections
- Some elements hold sections

##### For Tabs:
The first tab listed will be the default tab. If the general tab is not listed, it will be the default tab.

##### Each element in VLH has “propName”.
propName is used to map an element with one or more in the elements array returned by API response. UI elements, which include containers, will be mapped to more than one api element via UI element children.

Supported widgets are described in the paragraph below.

When server returns list of elements in API response, some or all of the elements may be found in VLH in different tabs and sections. Those, elements, which propertyNames are not found in VLH, will be added to an unnamed section in the General tab of the form. The unnamed section is the last section of the general tab.

### Supported element types in VLH
Most of elements in VLH have uiType property, except for text, number, and checkbox elements, which type is directly derived from API response elements with type “text”, “number”, and “boolean”.

#### Text
If element in VLH is mapped to an element in API response, which has type “text”, its UI type will be “text” by default.
Properties:
- propName <string>
- tooltip <string>
- help {position (top - default or bottom), text}
- placeholder <string>
- focus <boolean>
- size {full - default or half)
#### Number
Properties - the same as for Text element, where element in API response has type “number”
#### TextArea
Properties:
- propName <string>
- uiType = “textarea”
- tooltip <string>
- help <string>
#### Checkbox
If element in VLH is mapped to an element in API response, which has type “boolean”, its UI type will be “checkbox” by default.
Properties:
- propName <string>
- tooltip <string>
- inverted <boolean> optional - shows checkbox as checked if element value is false
- help {position (top - default or bottom) text}
#### Radio
This element is mapped to API response element with type “enum”, which provides options
Properties:
- propName <string>
- uiType = “radio”
- tooltip <string>
- help {position (top - default or bottom), text}
#### Select
Properties - same as for Radio element, but with uiType = “select”. Shown as a dropdown.
#### Duration
Shown as a triplet row <label> <multiplier number input> <duration unit dropdown>
Properties:
- propName <string>
- uiType = “duration”
- minOption <string> from [millisecond, second, minute, hour, day, week]
- help {position, text}
#### Host list
Shown as an expandable list of host - port pairs with ability to add new and remove pairs.
If element in VLH is mapped to an element in API response, which has type “host_list”, its UI 	type will be “host_list”.
propName default is “config.hostList”,
Properties:
- propName <string>
- uiType = “host_list”
- defaultPort <number> - optional (default 9200)
- hostPlaceholder <string> - optional
- portPlaceholder <string> - optional
- showOneRowForEmptyList <boolean> default = true
- help {position (top - default or bottom), text}
#### Property List
Shown as expandable list key - value pairs with ability to add new and remove pairs.
If element in VLH is mapped to an element in API response, which has type “property_list”, its UI type will be “property_list”.
Properties:
- propName <string>
- addLabel <string>
- emptyLabel <string>
- help {position (top or bottom), text}
#### Value List
Shown as expandable list of text inputs with ability to add new and remove items.
If element in VLH is mapped to an element in API response, which has type “value_list”, its UI type will be “value_list”. Label to each text input will be in API response element.label
Properties:
- propName <string>
- addLabel <string>
- emptyLabel <string>
- help {position (top or bottom), text}
#### Checkbox Enabled Container
Shown as a checkbox and a group of one or more elements, which may be enabled/disabled or shown/hidden depending on checkbox state.
Properties:
- propName <string> - for the checkbox element
- uiType = “check_enabled_container”
- container <object> - describes a form section (see section descriptions later in this document) or an individual element
- whenNotChecked <string> from [hide, disable (default)]
#### Selection Container
Depending on selector type this is shown as a set of tabs or a radio buttons group or a dropdown with options. When a tab or a radio or a dropdown option is selected, a corresponding container is shown. If no initial value is provided by server, first item returned from server definition will be selected. Propnames can overlap between containers. In these cases, the user value should be shared across the field. Only one container can be used at a time.
Properties:
- propName <string> - for the selector element
- uiType = “container_selection”
- selectorType <string> from [radio (default), tab, select]
  - options <array of objects>
each option has
    - the enum item that the container below belongs to
    - container <section definition object>
### Grouping of Elements in VLH
VLH describes how elements are grouped together by placing them into tabs and sections. Only one tab is displayed at a time. Multiple sections may be added to each tab. Some sections may have child sections.
#### Tab Definition
Properties:
- name <string> to be displayed in tabs selection (nav bar)
- title <string> - optional to be displayed on top of the tab content instead of the name
- hideTitle <boolean> - optional to hide title on top of the tab content
- tooltip <string> - optional text to show on mouseover of tooltip icon next to tab title
- isGeneral <boolean> - optional if true, then tab sections will be added to general section with icon, source type name, and description
- sections <array of objects> - section definitions
#### Section Definition
Properties:
- name: <string> - optional display name on top of the section
- tooltip: <string> - optional help text shown on mouseover of tooltip icon
- help: <position: top or bottom(default), text: inline text> - optional inline help text
- link: <position: top or bottom(default), url:<text>, label:<text, default ‘Learn more…’>> - external help link
- layout: <string: ‘row’ or ‘column’(default)> - row will try to place elements side by side, which may work with half size text inputs, checkbox, radio or select elements
- sections: [<section config>] - optional layer of sub-sections with display name, tooltip and elements
- elements: [<element config>] - array of section elements (element types are described above).
### Metadata in VLH
Additional properties are used at the top level of VLH structure:
- sourceType <string> - required - e.g. “REDSHIFT” or “MSSQL” to identify source form.
- tags: <array of strings> - optional e.g. [“beta”] means the source type has beta mode support.
- metadataRefresh <object> - optional to allow additional sections of Metadata Caching tab to be shown. (Dataset Details section is always shown.) If specified, it may have entries:
datasetDiscovery <boolean> - show Dataset Discovery section
authorization <boolean> - show Authorisatioin section

To describe configurable form structure VLH includes property:
form <object> with properties:
tabs <array of objects> - tab definitions (see above)

## Form Config in Combined JSON
Combined JSON will include data from API response and VLH.
When elements are found in both API response and VLH will get properties from both. Some complex elements use additional logic combining properties.

### Element Types
Each element, returned by API, has a “type” property:
- Simple type: { text,  number, boolean }
- List: { host_list, property_list, value_list }
- enum

Elements in VLH have optional “uiType” property, which indicates which UI widget is used to display and handle the element values. Elements from API response are merged with VLH elements using element.propertyName to generate final json structure used to show and manage the form. If VLH element does not have uiType property, then “type” is used to determine widget.
Some of the types in the next section below are not used in VLH, but injected by UI code.
The types are used as is: {text, number, host_list, property_list, value_list, credentials}.
The types use translations: {boolean -> checkbox, enum -> radio}.
The uiTypes, which modify ui presentation: {textarea, selector, duration}
The extra uiTypes, which encapsulate other elements:
- check_enabled_container
- container_selection
### Element config object
```
<element_config>:
simple elements have standard properties:
type: <string> - API mapped to the list above
propName: <string> - full form field name in VLH including “config.” prefix; mapped to API propertyName.
propertyName: <string> - API form field name; does not include “config.” prefix.
value: <string> - API optional initial value
label: <string> - API display name for the html input
focus: <boolean> - optional, indicating the input having initial focus
tooltip: <string> - optional help text shown on mouseover
           text type may have
         	placeholder: <string> - optional placeholder shown before user starts typing into text input
size: <string> - at this time either "full" or "half" used for width styling
secure: <boolean> - API optional flag to use password input instead of pure text
radio types have
	options: API [<label: <string>, value: <string>>]
	layout: <string: ‘column’ or ‘row’(default)>
custom elements properties usually include propName, which may have “.” in the text and other custom properties:
           duration type:
         	label: <string> API
         	propName: <string>
         	minOption: <string: one of {millisecond | second | minute | hour | day | week}> - to generate options
property_list
         	emptyLabel: <string> - text displayed if list is empty
addLabel: <string> - text on button/link to add entry to the list
This list has standard property name “config.propertyList[]” with each entry having “name” and “value”
initialValues: [<list entries>] - array of initial list entries that is always the empty list.
host_list
         	emptyLabel: <string> - text displayed if list is empty
addLabel: <string> - text on button/link to add entry to the list
This list has standard property name “config.hostList[]” with each entry having “hostname” and “port”
defaultPort: <number> - or if not specified, then 9200 is used.
value_list
	emptyLabel: <string> - text displayed if list is empty
addLabel: <string> - text on button/link to add entry to the list
propName: <string> -
label: <string> - API used for all text inputs in the list.
check_enabled_container - checkbox and container
	propName: <string> - used for checkbox input as well as for the whole widget in FE
value: <boolean> - API optional initial value for the checkbox
container: <object> - either a <section config> or one <element_config> (see above)
container_selection - set of radio buttons, or tabs with containers
	propName: <string> - used for radio button input as well as for the whole widget in FE
value: <string> - API optional initial value for the pre-selected radio option
options: [<options>] - API label/option pairs with associated container from VLH
	Additional element types added in the code, but not decorated in VLH
	credentials type - shows credentials widget when api returns element with type “credentials”
sharing type - shows access control list widget in the automatically added Sharing tab in EE
metadata_refresh - shows metadata caching sections in automatically added Metadata Caching tab
data_freshness - shows reflection policy widget in automatically added Reflection Refresh tab
```
### Elements summary for combined JSON
| Type / widget | propName | label | value | focus | tooltip/help | Custom props                   |
| --------------| ---------| ------| ------| ------| -------------| -------------------------------|
| text          |    Y     |   Y   |   Y   |   Y   |      Y       | size = {half | full (default)} |
|               |          |       |       |       |              | disabled, placeholder, secure  |
| number        |    Y     |   Y   |   Y   |   Y   |      Y       | Same as text, except secure.   |
| textarea      |    Y     |   Y   |       |       |      Y       | |
| checkbox      |    Y     |   Y   |   Y   |       |      Y       | |
| select        |    Y     |   Y   |   Y   |       |      Y       | options                        |
| radio         |    Y     |       |   Y   |       |      Y       | options                        |
| duration      |    Y     |   Y   |       |       |              | minOption,  disableIf {propname-value} |
| property_list |          |       |       |       |              | emptyLabel, addLabel           |
| host_list     |          |       |       |       |              | emptyLabel, addLabel           |
| value_list    |    Y     |   Y   |       |       |              | emptyLabel, addLabel           |
| check_enabled_container | Y |    |   Y   |       |              | container                      |
| container_selection     | Y |    |   Y   |       |              | options                        |

The list of element types in the table above covers the needs of the current source forms (v.2.0 of Dremio). Additional types will be added as needed.
If form elements have dependencies, they need to be wrapped into a custom element (e.g. Credentials includes radio buttons and text inputs, which depend on each other)

## Validation and Error Handling
Each element in VLH can have “validate” property, used in client side validation on form submittal attemp. Example: "validate": {"isRequired": true}

Validation error messages, coming from both client side and server side validation,
should be displayed next to corresponding form input fields.

## Sample JSON data
Default VLH JSON for the list or source types:
```
[
 {"sourceType": "REDSHIFT", “tags”: ["beta"]},
 {"sourceType": "S3", “tags” ["beta"]},
 {"sourceType": "HBASE", “tags” ["beta"]},
 {"sourceType": "MONGO", “tags” ["beta"]},
 {"sourceType": "POSTGRES", “tags” ["beta"]},
 {"sourceType": "ADL", “tags” ["beta"]},
 {"sourceType": "NEWDATA", “tags” ["beta"]},
 {"sourceType": "CASSANDRA", "disabled": true},
 {"sourceType": "SALESFORCE", "disabled": true},
 {"sourceType": "NETEZZA", "disabled": true},
 {"sourceType": "TERADATA", "disabled": true}
]
```
Sample api JSON response:
```
[
 {"label": "Redshift", "sourceType": "REDSHIFT"},
 {"label": "Amazon S3", "sourceType": "S3"},
 {"label": "Hive", "sourceType": "HIVE"},
 {"label": "Sample Source", "sourceType": "SampleSource"}
 {"label": "New Data", "sourceType": "NEWDATA", “icon”:”<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="48px" height="48px" … … </svg>”},
 {"sourceType": "SampleSource"}
]
```
When this api response is combined with defaults, the result will include only REDSHIFT, S3, HIVE, NEWDATA, and Sample. Tags will be added for all types from default, where available:
```
[
 {"label": "Amazon Redshift", "sourceType": "REDSHIFT", “tags” ["beta"]},
 {"label": "Amazon S3", "sourceType": "S3", “tags” ["beta"]},
 {"label": "Hive", "sourceType": "HIVE"},
 {"label": "NEWDATA", "sourceType": "NEWDATA", “tags” ["beta"], “icon”:”<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="48px" height="48px" … … </svg>”},
 {"label": "Sample Source", "sourceType": "SampleSource"}
]
```

Sample LVHF for REDSHIFT form (parens squeezed for compactness here):
```
{"sourceType": "REDSHIFT",  “tags”:["beta"],
 "metadataRefresh": {"datasetDiscovery": true},
 "form": { "tabs": [
   {
     "name": "General",
     "isGeneral": true,
     "sections": [
       {
         "name": "Connection",
         "elements": [
           {
             "propName": "config.connectionString",
             "validate": {"isRequired": true},
             "placeholder": "e.g. jdbc:redshift://123.123.123.123:5439/database",
             "help": {"position":"bottom", "text": "Your JDBC connection URL can be found in AWS console"}
           } ] },
       {
         "name": "Authentication",
         "elements": [
           {
             "propName": "config.authenticationType"
           } ] } ] },
   {
     "name": "Advanced Options",
     "sections": [
       {
         "help": {"position": "bottom", "text": "Set to 0 to have Dremio automatically decide."},
         "elements": [
           {
             "propName": "config.fetchSize",
             "tooltip": "Number of records to fetch at once. "
           } ] } ] } ] } }
```
Sample API response JSON for REDSHIFT form (parens squeezed):
```
{"sourceType": "REDSHIFT", "label": "Amazon Redshift", "elements": [
           {
             "type": "text",
             "label": "JDBC Connection String",
             "propertyName": "connectionString",
           } ,
           {
             "type": "credentials",
"propertyName": "authenticationType"
           },
           {
             "type": "number",
             "label": "Record fetch size",
             "propertyName": "fetchSize",
             "value": "0",
           } ] }
```
After combining two JSON structures, the following JSON will be generated for the UI to display:
```
{"label": "Amazon Redshift", "sourceType": "REDSHIFT", “tags”:["beta"],
 "metadataRefresh": {"datasetDiscovery": true},
 "form": { "tabs": [
   {
     "name": "General",
     "isGeneral": true,
     "sections": [
       {
         "name": "Connection",
         "elements": [
           {
             "type": "text",
             "propName": "config.connectionString",
             "label": "JDBC Connection String",
             "placeholder": "e.g. jdbc:redshift://123.123.123.123:5439/database",
             "help": {"position":"bottom", "text": "Your JDBC connection URL can be found in AWS console"},
             "validate": {"isRequired": true}
           } ] },
       {
         "name": "Authentication",
         "elements": [
           {
             "type": "credentials",
"propName": "config.authenticationType"
           } ] } ] },
   {
     "name": "Advanced Options",
     "sections": [
       {
         "help": {"position": "bottom", "text": "Set to 0 to have Dremio automatically decide."},
         "elements": [
           {
             "type": "number",
             "propName": "config.fetchSize",
             "label": "Record fetch size",
             "value": "0",
             "tooltip": "Number of records to fetch at once. "
           } ] } ] } ] } }
```

When client sends form values to the server upon user submit action, the request will include not only config.connectionString and config.fetchSize fields. It will also include many other fields:
- fields from “credentials” widget, specified in server api response,
- source name and description, present in every form,
- fields from acceleration widget, added to every form,
- fields from metadata_refresh widget, added due to default configuration,
- fields from sharing widget, added to every form in EE.
